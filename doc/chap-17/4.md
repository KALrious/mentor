Dans cette leçon on va créer la base de donnée de notre projet mentor à l'aide du service d'AWS relational database service (RDS). On en profitera aussi pour déployer la version finale de notre projet mentor.

#RDS

Pour créer une nouvelle base de donnée il faut suivre le lien ici (lien). Après avoir cliqué sur create database on va choisir le type de base de donnée que l'on veut créer, pour notre projet mentor ça sera maria-db.

Ensuite on choisira le template free-tier qui correspond à la création de RDS la moins chère d'AWS. En effet le mode free-tier alloue les capacité des serveurs non utilisé au maximum, ainsi on a pas de serveur dédié pour notre base de données.

Après avoir choisi un nom de base de donnée, on va renseigner les informations de username et de mot de passe pour se connecter à la base de données. Dans les additionnals configuration on va renseigner un nom de base de données: ebdb

#Code

On va mettre a jour notre code pour lui permettre d'être déployer en version finale. Dans le fichier ORM config on va modifier les configurations pour venir les cherchers depuis les variables d'environnements.

```
import { TypeOrmModuleOptions } from '@nestjs/typeorm';
import { DataSource, DataSourceOptions } from 'typeorm';
import { AnnounceEntity } from './announce/entities/announce.entity';
import { CourseEntity } from './course/entities/course.entity';
import { LevelEntity } from './level/entities/level.entity';
import { SubjectEntity } from './subject/entities/subject.entity';
import { UserEntity } from './user/entities/user.entity';

const { env } = process;

console.log(env);

const options: DataSourceOptions = {
  //@ts-ignore
  type: 'mariadb',
  host: env.DB_HOST,
  port: parseInt(env.DB_PORT),
  username: env.DB_USERNAME,
  password: env.DB_PASS,
  database: env.DB_NAME,
  migrationsRun: true,
  migrations: ['./dist/migration/*.js'],
  entities: [
    SubjectEntity,
    LevelEntity,
    AnnounceEntity,
    UserEntity,
    CourseEntity,
  ],
};

export const typeOrmModuleOptions: TypeOrmModuleOptions = {
  ...options,
  synchronize: false,
};

export const connectionSource = new DataSource(options);
```

pour utiliser les variables d'environnement dans ce fichier on va utiliser la librairie dotenv.

En plus de mettre à jour typeorm config on va créer un ProcFile :

```
web: npm run deploy
```

Et mettre à jour la commande de déploiement du package.json :

```
    "deploy": "npm ci && npm run build && npm run start:prod",
    "start:prod": "node dist/src/main",
```

#EBS

Une fois la base de données crée on va venir renseigner toutes les variables d'environnements nécessaire au fonctionnement de notre application au sein de notre de l'EBS crée précédemment. Il faut aller dans la section configuration de notre environnement et en bas de page renseigner une à une toutes clef valeurs de nos variable d'environnement.

#Code Pipeline

Au sein du code pipeline crée précédemment on va faire en sorte de déployer la version finale de notre code sur l'EBS.

On va permettre a notre pipeline de déployer des tags de notre applications. (définition tag gpt)

On va cliquer sur edit pipeline et cliquer sur add trigger. En rajoutant un spécifique filter sur les tags de type v*.*.\* on va pouvoir lancer le pipeline de CD à chaque fois qu'un nouveau au format définit ci-dessus est déployer sur notre répertoire distant.

Pour créer un nouveau tag et le déployer sur le répertoire distant il faut utiliser les commandes suivantes :

```
git tag v1.0.0
git push tags
```

Une fois la pipeline terminé on peut retourner sur EBS pour récupérer s'assurer du résultat. En récupérant le domaine de l'EBS déployé, on peut tester notre application déployé sur le cloud à l'aide de Postman.
